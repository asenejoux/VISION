<script>
// ==========================================
// 1. LOGIQUE D'AUTHENTIFICATION
// ==========================================

const loginScreen = document.getElementById('login-screen');
const appContainer = document.getElementById('app-container');
const loginInput = document.getElementById('access-code-input');
const loginStatus = document.getElementById('login-status');
const loginBtn = document.getElementById('login-btn');
const userBadge = document.getElementById('user-badge');

// Gestion de la touche Entr√©e
function handleLoginKey(event) { 
    if (event.key === 'Enter') attemptLogin(); 
}

// Tentative de connexion
function attemptLogin() {
    const code = loginInput.value;
    if (!code) return;
    if(typeof playSfx === 'function') playSfx('click');
    
    loginStatus.textContent = "VERIFYING_HASH...";
    loginStatus.className = "h-6 text-center font-mono text-xs text-cyber-cyan animate-pulse";
    loginBtn.disabled = true;
    loginInput.disabled = true;

    google.script.run
        .withSuccessHandler(onLoginSuccess)
        .withFailureHandler(onLoginFailure)
        .verifyAccess(code);
}

// Succ√®s de connexion
function onLoginSuccess(response) {
    if (response.success) {
        if(typeof playSfx === 'function') playSfx('success');
        loginStatus.textContent = "ACCESS_GRANTED";
        loginStatus.className = "h-6 text-center font-mono text-xs text-green-500";
        if(response.user) userBadge.textContent = response.user.toUpperCase().split('@')[0];
        
        setTimeout(() => {
            loginScreen.style.opacity = '0';
            loginScreen.style.pointerEvents = 'none';
            appContainer.classList.remove('hidden-view');
            document.body.style.overflow = 'auto';
            
            // Initialisation diff√©r√©e
            setTimeout(() => {
                if(portfolioGrid.innerHTML === "") initPortfolio();
            }, 100);
        }, 800);
    } else {
        onLoginFailure();
    }
}

// √âchec de connexion
function onLoginFailure() {
    if(typeof playSfx === 'function') playSfx('error');
    loginStatus.textContent = "ACCESS_DENIED // INVALID_TOKEN";
    loginStatus.className = "h-6 text-center font-mono text-xs text-red-500 glitch-text";
    loginBtn.disabled = false;
    loginInput.disabled = false;
    loginInput.value = "";
    loginInput.focus();
    loginInput.classList.add('border-red-500');
    setTimeout(() => loginInput.classList.remove('border-red-500'), 500);
}


// ==========================================
// 2. MOTEUR D'AFFICHAGE & NAVIGATION
// ==========================================

const portfolioGrid = document.getElementById('portfolio-grid');
const projectDetail = document.getElementById('project-detail');
const detailContainer = document.getElementById('detail-content');
const backButton = document.getElementById('back-btn');

// Fonction globale de retour
window.returnToLobby = function() {
    if(typeof playSfx === 'function') playSfx('back');
    
    const projectDetail = document.getElementById('project-detail');
    const mainLobby = document.getElementById('main-lobby');
    
    // Logique de bascule
    projectDetail.classList.add('hidden-view');
    mainLobby.classList.remove('hidden-view');
    mainLobby.classList.add('fade-in');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

if(backButton) {
    backButton.addEventListener('click', window.returnToLobby);
}

function initPortfolio() {
    if (!window.projectsData || window.projectsData.length === 0) {
        portfolioGrid.innerHTML = '<div class="text-red-500 font-mono border border-red-500 p-4">ERREUR CRITIQUE: Aucune donn√©e projet d√©tect√©e.</div>';
        return;
    }
    renderGrid(window.projectsData);
}

function filterProjects(category) {
    if(typeof playSfx === 'function') playSfx('click');
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('border-cyber-cyan', 'text-cyber-cyan', 'bg-cyber-cyan/10', 'active');
        btn.classList.add('border-slate-700', 'text-slate-500');
    });
    
    const activeBtn = Array.from(document.querySelectorAll('.filter-btn')).find(b => b.innerText.includes(category.toUpperCase().replace('_', ' '))) || document.querySelector('.filter-btn');
    if(activeBtn) {
        activeBtn.classList.remove('border-slate-700', 'text-slate-500');
        activeBtn.classList.add('border-cyber-cyan', 'text-cyber-cyan', 'bg-cyber-cyan/10', 'active');
    }

    if (category === 'all') {
        renderGrid(window.projectsData);
    } else {
        const filtered = window.projectsData.filter(p => {
            const searchStr = (p.tags.join(' ') + ' ' + p.subtitle + ' ' + p.title).toLowerCase();
            return searchStr.includes(category.toLowerCase());
        });
        renderGrid(filtered);
    }
}

function renderGrid(projects) {
    portfolioGrid.style.opacity = '0';
    setTimeout(() => {
        if (projects.length === 0) {
            portfolioGrid.innerHTML = '<div class="col-span-full text-center font-mono text-slate-600 py-12">NO_RESULTS_FOUND // TRY_ANOTHER_PROTOCOL</div>';
        } else {
            portfolioGrid.innerHTML = projects.map(project => `
                <div class="cyber-card p-6 cursor-pointer group h-full flex flex-col transition-all duration-300 hover:scale-[1.02]" 
                     onclick="openProject('${project.id}')" onmouseenter="if(typeof playSfx === 'function') playSfx('hover')" style="border-color: ${project.colorHex}40">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-xs font-mono text-slate-500 border border-slate-700 px-2 py-1 rounded">ID: ${project.id.toUpperCase()}</span>
                        <div class="w-2 h-2 rounded-full transition-colors duration-300" style="background-color: ${project.colorHex}; box-shadow: 0 0 10px ${project.colorHex}"></div>
                    </div>
                    
                    <h3 class="text-2xl font-display font-bold text-white mb-2 group-hover:text-[${project.colorHex}] transition-colors">
                        ${project.title}
                    </h3>
                    <p class="text-sm font-mono mb-4 opacity-80" style="color: ${project.colorHex}">${project.subtitle}</p>
                    
                    <p class="text-slate-400 text-sm mb-6 flex-grow line-clamp-3">${project.summary}</p>
                    
                    <div class="flex flex-wrap gap-2 mt-auto">
                        ${project.tags.map(tag => `
                            <span class="text-xs bg-slate-900 text-slate-300 px-2 py-1 border-l-2" style="border-color: ${project.colorHex}">${tag}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        portfolioGrid.style.opacity = '1';
    }, 200);
}

// === G√âN√âRATEUR DE TEMPLATE V3 (INTEGRATED) ===
window.openProject = function(id) {
    if(typeof playSfx === 'function') playSfx('click');
    const project = window.projectsData.find(p => p.id === id);
    if (!project) return;

    document.getElementById('main-lobby').classList.add('hidden-view');
    const projectDetail = document.getElementById('project-detail');
    projectDetail.classList.remove('hidden-view');
    window.scrollTo(0,0);

    const detailContainer = document.getElementById('detail-content');
    detailContainer.style.setProperty('--theme-color', project.colorHex);
    document.title = `SYSTEM // ${project.id.toUpperCase()}`;

    let html = `
        <header class="min-h-[60vh] flex flex-col justify-center relative mb-24 reveal-item opacity-0 transform translate-y-4 transition-all duration-700">
            <div class="absolute top-0 right-0 p-4 border border-[var(--theme-color)]/30 rounded text-right bg-slate-900/50 backdrop-blur">
                <div class="text-xs font-mono" style="color: var(--theme-color)">STATUS: DEPLOYED</div>
                <div class="text-xs text-slate-500 font-mono">ID: ${project.id.toUpperCase()}</div>
            </div>
            <div class="mb-6 inline-block">
                <span class="bg-[var(--theme-color)]/10 border px-3 py-1 rounded text-xs tracking-[0.2em] font-mono" style="color: var(--theme-color); border-color: var(--theme-color)">
                    ${project.tags[0].toUpperCase()}
                </span>
            </div>
            <h1 class="text-5xl md:text-7xl lg:text-8xl font-display font-black text-white mb-6 tracking-tighter leading-none" id="detail-title"></h1>
            <h2 class="text-xl md:text-3xl font-light tracking-widest mb-8 uppercase font-display flex items-center gap-4">
                <span class="w-8 h-[2px]" style="background-color: var(--theme-color)"></span>
                <span style="color: var(--theme-color)">${project.subtitle}</span>
            </h2>
            <p class="text-slate-400 text-lg md:text-xl max-w-3xl leading-relaxed border-l-4 pl-6" style="border-color: var(--theme-color)">${project.summary}</p>
        </header>
    `;

    if (project.mythology) {
        html += `
        <section class="mb-32 relative reveal-item opacity-0 transform translate-y-4 transition-all duration-700 delay-100">
            <div class="flex items-end gap-4 mb-12 border-b border-slate-800 pb-4">
                <span class="text-6xl font-black text-slate-800/50 font-display -mb-2">00</span>
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wide font-display">Origine <span style="color: var(--theme-color)">Cod√©e</span></h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div class="cyber-border p-8 bg-slate-900/50 backdrop-blur relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-[var(--theme-color)] to-transparent opacity-20 blur group-hover:opacity-40 transition-opacity"></div>
                    <div class="relative">
                        <div class="text-xs mb-2 font-mono" style="color: var(--theme-color)">/// ARCHIVE_MYTHOS</div>
                        <h3 class="text-3xl font-bold text-white mb-4 font-display">${project.mythology.title}</h3>
                        <p class="text-slate-400 leading-relaxed text-sm text-justify">${project.mythology.text}</p>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="flex items-start gap-4 p-4 border-l-2" style="border-color: var(--theme-color)">
                        <div class="text-4xl">üèõÔ∏è</div>
                        <div>
                            <strong class="text-white text-lg block mb-1 font-display">SIGNIFICATION</strong>
                            <p class="text-sm text-slate-400">${project.mythology.meaning}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>`;
    }

    if (project.analogy) {
        html += `
        <section class="mb-32 reveal-item opacity-0 transform translate-y-4 transition-all duration-700 delay-200">
            <div class="flex items-end gap-4 mb-12 border-b border-slate-800 pb-4">
                <span class="text-6xl font-black text-slate-800/50 font-display -mb-2">01</span>
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wide font-display">Analogie <span style="color: var(--theme-color)">Syst√®me</span></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${project.analogy.cards.map((card, i) => `
                <div class="cyber-card p-6 pt-12 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-2 text-8xl font-black text-slate-800/20 font-display -mr-4 -mt-4 transition-transform group-hover:scale-110">0${i+1}</div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-white mb-3 group-hover:text-[var(--theme-color)] transition-colors font-display">${card.title}</h3>
                        <div class="h-0.5 w-12 mb-4 bg-slate-700 group-hover:w-full transition-all duration-500" style="background-color: var(--theme-color)"></div>
                        <p class="text-slate-400 text-sm leading-relaxed">${card.text}</p>
                    </div>
                </div>`).join('')}
            </div>
        </section>`;
    }

    if (project.workflow) {
        html += `
        <section class="mb-32 reveal-item opacity-0 transform translate-y-4 transition-all duration-700 delay-300">
            <div class="flex items-end gap-4 mb-12 border-b border-slate-800 pb-4">
                <span class="text-6xl font-black text-slate-800/50 font-display -mb-2">02</span>
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wide font-display">Workflow <span style="color: var(--theme-color)">Op√©rationnel</span></h2>
            </div>
            <div class="relative space-y-8 before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-700 before:to-transparent">
                ${project.workflow.map((step, i) => `
                <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                    <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 border-slate-700 bg-slate-900 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 group-hover:border-[var(--theme-color)] transition-colors z-10">
                        <span class="text-xs font-mono font-bold" style="color: var(--theme-color)">${i+1}</span>
                    </div>
                    <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-6 cyber-card border-l-4 md:group-odd:border-l-0 md:group-odd:border-r-4" style="border-color: var(--theme-color)">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-white font-display text-lg">${step.title}</h3>
                            <span class="text-[10px] font-mono px-2 py-0.5 rounded bg-slate-800 text-slate-400 border border-slate-700">${step.phase || 'STEP ' + (i+1)}</span>
                        </div>
                        <p class="text-sm text-slate-400 leading-relaxed">${step.text}</p>
                    </div>
                </div>
                `).join('')}
            </div>
        </section>`;
    }

    if (project.features) {
        html += `
        <section class="mb-32 reveal-item opacity-0 transform translate-y-4 transition-all duration-700 delay-400">
            <div class="flex items-end gap-4 mb-12 border-b border-slate-800 pb-4">
                <span class="text-6xl font-black text-slate-800/50 font-display -mb-2">03</span>
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wide font-display">Capacit√©s <span style="color: var(--theme-color)">Tactiques</span></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${project.features.map(feat => `
                <div class="flex items-start gap-4 p-4 border border-slate-800 bg-slate-900/30 hover:bg-slate-800/50 transition-colors rounded">
                    <div class="mt-1 text-[var(--theme-color)]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                    <div>
                        <strong class="text-slate-200 text-sm font-bold block mb-1">${feat.title}</strong>
                        <p class="text-xs text-slate-500">${feat.text}</p>
                    </div>
                </div>
                `).join('')}
            </div>
        </section>`;
    }

    if (project.branding && !project.features) {
         html += `
        <section class="mb-32 reveal-item opacity-0 transform translate-y-4 transition-all duration-700">
             <div class="bg-slate-900 border border-slate-700 p-1 rounded-xl">
                <div class="bg-black rounded-lg p-8 border border-slate-800 relative overflow-hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div class="flex flex-col justify-center">
                            <h3 class="text-5xl font-black text-white tracking-tighter mb-2 font-display">BRAND <span style="color: var(--theme-color)">IDENTITY</span></h3>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            ${project.branding.cards.map(card => `
                            <div class="flex items-center gap-4">
                                <div class="w-1 h-full" style="background-color: var(--theme-color)"></div>
                                <div>
                                    <strong class="text-white block font-display tracking-wide">${card.title}</strong>
                                    <span class="text-slate-400 text-xs">${card.text}</span>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </section>`;
    }

    if (project.tech) {
        html += `
        <section class="mb-20 reveal-item opacity-0 transform translate-y-4 transition-all duration-700 delay-500">
            <div class="flex items-end gap-4 mb-8 border-b border-slate-800 pb-4">
                <span class="text-6xl font-black text-slate-800/50 font-display -mb-2">04</span>
                <h2 class="text-3xl md:text-4xl font-bold text-white uppercase tracking-wide font-display">Architecture <span style="color: var(--theme-color)">Technique</span></h2>
            </div>
            <div class="cyber-border p-6 rounded bg-slate-900/80 mb-6 border-l-4" style="border-left-color: var(--theme-color)">
                <p class="text-sm md:text-base text-slate-300 leading-relaxed font-mono">${project.tech.text}</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${project.tech.stack.map(item => `
                <div class="bg-slate-950 p-3 rounded text-center border border-slate-800 hover:border-[var(--theme-color)] transition-colors group">
                    <span class="font-mono text-xs text-slate-500 group-hover:text-white transition-colors">${item}</span>
                </div>`).join('')}
            </div>
        </section>`;
    }

    // FALLBACK LEGACY
    if (!project.mythology && !project.analogy && !project.workflow && project.content) {
         html += `<div class="p-4 border border-yellow-500/50 text-yellow-500 font-mono text-xs mb-8">‚ö†Ô∏è LEGACY_MODE_ACTIVATED</div>`;
         // Fallback legacy code... (simplifi√© pour le fix)
         html += project.content.map(b => `<p class="mb-4 text-slate-400">${b.body || b.text || ''}</p>`).join('');
    }

    html += `
        <div class="mt-20 pt-8 border-t border-slate-800 text-center reveal-item opacity-0">
             <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 border border-slate-800">
                <div class="w-2 h-2 rounded-full animate-pulse" style="background-color: var(--theme-color)"></div>
                <span class="text-[10px] font-mono text-slate-400">END_OF_FILE // ${project.id.toUpperCase()}</span>
             </div>
        </div>
    `;

    detailContainer.innerHTML = html;

    const titleEl = document.getElementById('detail-title');
    if (typeof TextScramble !== 'undefined' && titleEl) {
        const fx = new TextScramble(titleEl);
        fx.setText(project.title);
    } else if (titleEl) {
        titleEl.textContent = project.title;
    }

    const items = document.querySelectorAll('.reveal-item');
    items.forEach((item, index) => {
        setTimeout(() => {
            item.classList.remove('opacity-0', 'translate-y-4');
            item.style.opacity = "1";
            if(Math.random() > 0.6 && typeof playSfx === 'function') playSfx('type');
        }, 100 + (index * 100));
    });
};

// ==========================================
// 3. GESTION PROFIL
// ==========================================

const profileModal = document.getElementById('profile-modal');
const profileContent = document.getElementById('profile-content');

function openProfile() {
    profileModal.classList.remove('hidden');
    setTimeout(() => {
        profileModal.classList.remove('opacity-0');
        profileContent.classList.remove('scale-95');
        profileContent.classList.add('scale-100');
    }, 10);
}

function closeProfile() {
    profileModal.classList.add('opacity-0');
    profileContent.classList.remove('scale-100');
    profileContent.classList.add('scale-95');
    setTimeout(() => {
        profileModal.classList.add('hidden');
    }, 300);
}

if(profileModal) {
    profileModal.addEventListener('click', (e) => {
        if (e.target === profileModal) closeProfile();
    });
}
</script>